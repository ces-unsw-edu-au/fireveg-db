---
title: "Fireveg-DB : summary of available data for Blue Table"
author: "Ferrer-Paris, J.R."
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
always_allow_html: true
---

```{r setup, include=FALSE}
require(dplyr)
require(readxl)
require(xml2)
require(readr)
require(magrittr)

input.dir <- "~/proyectos/UNSW/fireveg-db/input"
```

Brief (and very preliminary) summary of fire-related plant traits extracted from literature and unpublished references by two main sources: the NSW Flora Fire Response Database (v2.1, 2010, updated 2014), and Austraits (data provided by Will Cornwell, 23 April 2021). This document is currently under development.

# Data sources and formats

We first read the data from the NSW FFRD spreadsheet. This is in wide tabular format: each column is a variable.
```{r}
nswffrd.data <- read_excel(sprintf("%s/NSWFFRDv2.1.xlsx",input.dir), sheet=2, skip=1)
# nswffrd.data
```

The data exported from Austraits by Will is in a long format: column `trait_name` give the variable names and the `value` column has the trait values:
```{r}
 austrait.data <- read_csv(sprintf("%s/blue-table-v0.0.2.csv",input.dir), col_types="cccccccccccc")
#  austrait.data

```

# Traits

## Fire response

In the NSWFFRDv2 spreadsheet the variable `Firesponse` is coded in the following way:

> S=seeder, R=resprouter. r=usually killed but sometimes resprouts, s=usually resprouts but sometimes killed; these may indicate a variable response seen by one observer, or a conflict between different observers (see comments column). When an equal number of references list the species as seeder or resprouter, this column reads as 'S/R' and details are given in the comments cloumn. Ideally fire response should be defined by mortality >70%=seeder, mortality <30%=resprouter [Gill & Bradstock, 1992].

```{r}
nswffrd.data %>% select(Fireresponse) %>% table
```

We can rescale these values as suggested by David:
```{r}
Resprouting <- c("S"="None", "Sr"="Few", "S/R"="Half", "SR"="Half", "Rs"="Most", "R"="All")
nswffrd.data %>% transmute(fire_response=Resprouting[Fireresponse]) %>% table
```

Austraits data includes observations from the NSWFFRDv2 spreadsheet (`dataset_id=Auld_2014`) but the values are coded differently:

```{r}
austrait.data %>% filter(dataset_id %in% "Auld_2014" & trait_name %in% "fire_response") %>% pull(value) %>% table
```

Data for the same trait but from other data sources has following values in Austraits dataset:

```{r}
austrait.data %>% filter(!dataset_id %in% "Auld_2014" & trait_name %in% "fire_response") %>% pull(value) %>% table
```


## Resprouting organ


In the NSWFFRDv2 spreadsheet the variable resprout location is coded in the following way:

> Source of buds for vegetative regenerators. Plum text indicates that the source of this information is from the fire response category given by one or more references (see Fire Response columns); a- indicates this is an assumption based on the species morphology. Where multiple methods are given: seperated by & both methods recorded by one observer; seperated by / different methods recorded by different observers. Where a category 4 fire response is given without specifying root suckers or rhizome, root suckers is listed here.

There are many possible values, sometimes used in combination:

```{r}
nswffrd.data %>% distinct(`Resprout location`) %>% head
```

We can use a similar approach as before in order to translate the most common values, but some fixed are required to adjust some fields and extract multiple values :

```{r}

 RegenerativeOrgan <- c("epicormic"="Epicormic",
 "stemp buds"="Epicormic",
 "apical"="Apical",
 "lignotuber"="Lignotuber",
 "rootstock"="Lignotuber",
 "root stock"="Lignotuber",
 "basal"="Basal",
 "coppice"="Basal",
 "tuber"="Tuber",
 "taproot"="Tuber",
 "tussock"="Tussock",
 "rhizome"="Long rhizome or root sucker",
 "root sucker"="Long rhizome or root sucker",
 "rootucker"="Long rhizome or root sucker",
 "root buds"="Long rhizome or root sucker",
 "rhizome"="Short rhizome",
 "stolon"="Stolon",
 "stolons"="Stolon")
 nswffrd.data %>% transmute(regen_organ= RegenerativeOrgan[`Resprout location`]) %>% table(.,useNA='always')

```


Austraits data includes observations from the NSWFFRDv2 spreadsheet (`dataset_id=Auld_2014`) and other references using several distinct values. For example reference `Clarke_2015` has 2223 observations from 2093 distinct taxa and uses 6 different categories ranging from 'aboveground_caudex' to 'underground':

```{r}
austrait.data %>% filter(trait_name %in% "regen_strategy" ) %>% group_by(dataset_id) %>%  summarise(`n taxa`=n_distinct(taxon_name), `n values`=n_distinct(value), `n obs`=n(), min=min(value), max=max(value))
```


## Maximum bark thickness

Austraits data reports this as quantitative values:

```{r}
austrait.data %>% filter(trait_name %in% "bark_thickness" ) %>% group_by(dataset_id) %>% mutate(value=as.numeric(value)) %>% summarise(min=min(value),max=max(value),mean=mean(value),sd=sd(value),count=n())
```


## Seed mass

Austraits data report quantitative data from several sources:

```{r}
austrait.data %>% filter(trait_name %in% "seed_mass" ) %>% group_by(dataset_id) %>% mutate(value=as.numeric(value)) %>% summarise(min=min(value),max=max(value),mean=mean(value),sd=sd(value),count=n())
```

## Propagule dispersal model

From the NSWFFRDv2 spreadsheet:

> Seed Dispersal mechanism:	Known vector for dispersal (wind, bird, ants, mammal, adhesion, etc); a- indicates seed is adapted for dispersal by the given vector (but not necessarily shown to use this vector); ? indicates possible vector

```{r}
nswffrd.data %>% group_by(`Seed dispersal mechanism`) %>% summarise(count=n())
```

This could be transformed into a value with two attributes to indicate (a) if it is based on "adaptations" or if it is a known dispersal vector, and (b) the certainty of the observation.

In Austraits this is coded as trait `dispersal_syndrome` with several possible values but no attributes:

```{r}
austrait.data %>% filter(trait_name %in% "dispersal_syndrome" ) %>% group_by(dataset_id) %>%  summarise(`n taxa`=n_distinct(taxon_name), `n values`=n_distinct(value), `n obs`=n(), min=min(value), max=max(value))

```


## Seedbank type

In the NSWFFRDv2 spreadsheet the trait `Seed storage` is coded in following way:

> The following definitions have been used for seed-bank type. Soil seedbank: persistent=some carry over of viable seeds from year to year, transient=no viable seeds persist for more than 1 year [Thompson & Grime 1979 JEc 67:893-921]; Canopy seedbank: serotinous=most seed retained for a few years (released by fire, death, drying over time) [Lamont et al 1991 BotRev 57:277-317] canopy transient=retained on plant for short period only. Plum text indicates that the source of this information is from the fire response category given by one or more references (see Fire Response columns); blue text indicates this is an assumption based on the species morphology.

```{r}
nswffrd.data %>% group_by(`Seed storage`) %>% summarise(count=n())
```

Some attributes (coded as text colors, references in hyperlinks) are lost when reading the data in this way. Some fields start with `a-` or have multiple values joined by `&` or `/`, others have notes in parenthesis.


In Austraits: according to the Sync table suggested by Will and Mark this is currently represented in three columns:  serotiny + soil_seedbank +  seed_storage_location.

> *Canopy seedbank*: Seeds retained in serotinos or bradysporous woody fruits in the plant canopy and released after scorch (may also be released spontaneously)	Some species of Banksia, Hakea, Allocasuarina, Leptosperum, Eucalypts, Callitris

> *Soil-persistent seedbank*: Seeds  or fruits released from the parent plant at maturity, with a non-trivial fraction that remains viable in the soil for more than one year and able to germinate after fire	Many species of Fabaceae, Ericaceae, Rutaceae, Rhamnaceae, Grevillea, Persoonia

> *Transient seedbank*: Seeds  or fruits released from the parent plant at maturity and do not remain viable in the soil for more than one year (i.e. germinate or die within one year)	Some grasses, figs, orchids, most lilioid genera, Syzygium, Loranthaceae

> *Non-canopy*: Not a canopy seedbank, but could be with soil persistent ot transient	No evidence of serotinous fruits, but otherwsie uncertain


_Soil seedbank_ is reported in Austraits as a binary variable per species:
```{r}
austrait.data %>% filter(trait_name %in% "soil_seedbank" ) %>% group_by(dataset_id,value,unit) %>%  summarise(`n taxa`=n_distinct(taxon_name), `n obs`=n())
```


_Seed storage location_

```{r}
austrait.data %>% filter(trait_name %in% "seed_storage_location" ) %>% group_by(dataset_id,value) %>%  summarise(`n taxa`=n_distinct(taxon_name),  `n obs`=n())
```

_Serotiny_ is recorded as a variable with either binary values (not_serotinous vs. serotinous) or ordinal scale (low, moderate, high):


```{r}
austrait.data %>% filter(trait_name %in% "serotiny" ) %>% group_by(dataset_id,value) %>%  summarise(`n taxa`=n_distinct(taxon_name),  `n obs`=n())
```



## Recruitment pattern

This variable is reported in Austraits from a single source with one or more observations per species:

```{r}
austrait.data %>% filter(trait_name %in% "fire_and_establishing" ) %>% group_by(dataset_id,value) %>%  summarise(`n taxa`=n_distinct(taxon_name), `n obs`=n())
```

## Germination cue


In the NSWFFRDv2 spreadsheet the trait `Germination cue` is coded in following way:

> Germination is stimulated by a fire-related (e.g. heat, smoke) or other (e.g. stratification, leaching) cue; a- indicates seed is adapted for given cue (ie hard seed coat adapted for heat cue)

```{r}
nswffrd.data %>% group_by(`Germination cue`) %>% summarise(count=n())
```


This variable is reported in Austraits from several sources with different coding of values (Check with Will?)

```{r}
austrait.data %>% filter(trait_name %in% "fire_cued_seeding" ) %>% group_by(dataset_id) %>%  summarise(`n taxa`=n_distinct(taxon_name), `n values`=n_distinct(value), `n obs`=n(), min=min(value), max=max(value))
```

## Fire_response_juvenile

This is reported in Austraits from a single source as a  variable with two possible values:

```{r}
austrait.data %>% filter(trait_name %in% "fire_response_juvenile" ) %>% group_by(dataset_id,value,unit) %>%  summarise(`n taxa`=n_distinct(taxon_name), `n obs`=n())
```

## Fire_response_on_maturity
This is reported in Austraits from a single source as a  variable with three possible values:

```{r}
austrait.data %>% filter(trait_name %in% "fire_response_on_maturity" ) %>% group_by(dataset_id,value,unit) %>%  summarise(`n taxa`=n_distinct(taxon_name), `n obs`=n())

```

## Germination treatment

This is reported in Austraits from three different sources and many possible values (Check with Will?):

```{r}
austrait.data %>% filter(trait_name %in% "germination_treatment" ) %>% group_by(dataset_id) %>%  summarise(`n taxa`=n_distinct(taxon_name), `n values`=n_distinct(value), `n obs`=n(), min=min(value), max=max(value))
```

## Lifespan

This is reported in Austraits from few sources and several possible values:
```{r}
austrait.data %>% filter(trait_name %in% "lifespan" ) %>% group_by(dataset_id,value,unit) %>%  summarise(count=n())
```



## Time_from_fire_to_fruit

This is reported in Austraits from two sources and four possible values:

```{r}
austrait.data %>% filter(trait_name %in% "time_from_fire_to_fruit" ) %>% group_by(dataset_id,value,unit) %>%  summarise(`n taxa`=n_distinct(taxon_name),  `n obs`=n())
```
